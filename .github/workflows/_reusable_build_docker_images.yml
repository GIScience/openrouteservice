name: Build Docker Images (Reusable)
description: Reusable workflow to build Docker images for multiple platforms and stages

on:
  workflow_call:
    inputs:
      push:
        description: Whether to push the image to a registry
        type: boolean
        default: false
      tags_publish_amd64:
        description: Docker tag for publish image on amd64
        type: string
        default: 'local/openrouteservice:test'
      tags_publish_arm64:
        description: Docker tag for publish image on arm64
        type: string
        default: 'local/openrouteservice:test'
      tags_minimal_amd64:
        description: Docker tag for minimal image on amd64
        type: string
        default: 'local/openrouteservice:test-minimal'
      tags_minimal_arm64:
        description: Docker tag for minimal image on arm64
        type: string
        default: 'local/openrouteservice:test-minimal'
      cache_from_type:
        description: Cache backend type (default gha for GitHub Actions)
        type: string
        default: 'gha'
      java_version:
        description: Java version to use for Maven builds
        type: string
        default: '21'
      skip_arm64:
        description: Skip ARM64 builds
        type: boolean
        default: false
    outputs:
      dockerfile_hash:
        description: Hash of the Dockerfile
        value: ${{ jobs.prepare_environment.outputs.dockerfile_hash }}

jobs:
  prepare_environment:
    name: Prepare the environment variables
    runs-on: ubuntu-latest
    outputs:
      dockerfile_hash: ${{ steps.dockerfile-hash.outputs.hash }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Generate Dockerfile hash
        id: dockerfile-hash
        run: |
          HASH=$(sha256sum Dockerfile | cut -d' ' -f1 | cut -c1-8)
          echo "hash=$HASH" >> $GITHUB_OUTPUT

  prepare_maven_dependencies:
    name: Prepare Maven dependencies for ${{ matrix.name }}
    runs-on: ${{ matrix.runner }}
    needs:
      - prepare_environment
    strategy:
      matrix:
        include:
          - platform: linux/amd64
            name: linux-amd64
            runner: ubuntu-latest
          - platform: linux/arm64
            name: linux-arm64
            runner: ubuntu-24.04-arm
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

  build_docker_images:
    name: Build ${{ matrix.image_stage }} for ${{ matrix.name }}
    runs-on: ${{ matrix.runner }}
    needs:
      - prepare_environment
      - prepare_maven_dependencies
    strategy:
      matrix:
        include:
          - platform: linux/amd64
            name: linux-amd64
            runner: ubuntu-latest
            image_stage: publish
            docker_tag_input: tags_publish_amd64
          - platform: linux/arm64
            name: linux-arm64
            runner: ubuntu-24.04-arm
            image_stage: publish
            docker_tag_input: tags_publish_arm64
          - platform: linux/amd64
            name: linux-amd64
            runner: ubuntu-latest
            image_stage: minimal
            docker_tag_input: tags_minimal_amd64
          - platform: linux/arm64
            name: linux-arm64
            runner: ubuntu-24.04-arm
            image_stage: minimal
            docker_tag_input: tags_minimal_arm64
    steps:
      - name: Check if should skip (ARM64)
        id: should_skip
        env:
          MATRIX_NAME: ${{ matrix.name }}
          SKIP_ARM64: ${{ inputs.skip_arm64 }}
        run: |
          SKIP="false"
          # Skip ARM64 builds if requested
          if [[ "$MATRIX_NAME" == "linux-arm64" && "$SKIP_ARM64" == "true" ]]; then
            SKIP="true"
          fi
          echo "skip=$SKIP" >> $GITHUB_OUTPUT

      - name: Checkout
        if: steps.should_skip.outputs.skip != 'true'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get and save the UID
        if: steps.should_skip.outputs.skip != 'true'
        run: |
          echo "UID=$(id -u)" >> $GITHUB_ENV

      - name: Set up build environment
        if: steps.should_skip.outputs.skip != 'true'
        uses: ./.github/actions/setup-build-environment
        with:
          java_version: ${{ inputs.java_version }}
          dockerfile: 'Dockerfile'

      - name: Resolve Docker tag
        if: steps.should_skip.outputs.skip != 'true'
        id: resolve_tag
        env:
          TAG_INPUT: ${{ matrix.docker_tag_input }}
          TAGS_PUBLISH_AMD64: ${{ inputs.tags_publish_amd64 }}
          TAGS_PUBLISH_ARM64: ${{ inputs.tags_publish_arm64 }}
          TAGS_MINIMAL_AMD64: ${{ inputs.tags_minimal_amd64 }}
          TAGS_MINIMAL_ARM64: ${{ inputs.tags_minimal_arm64 }}
        run: |
          case "$TAG_INPUT" in
            tags_publish_amd64) TAG="$TAGS_PUBLISH_AMD64" ;;
            tags_publish_arm64) TAG="$TAGS_PUBLISH_ARM64" ;;
            tags_minimal_amd64) TAG="$TAGS_MINIMAL_AMD64" ;;
            tags_minimal_arm64) TAG="$TAGS_MINIMAL_ARM64" ;;
            *) TAG="local/openrouteservice:test" ;;
          esac
          echo "tag=$TAG" >> $GITHUB_OUTPUT

      - name: Determine Docker output
        if: steps.should_skip.outputs.skip != 'true'
        id: output
        env:
          PUSH: ${{ inputs.push }}
          RUNNER_TEMP: ${{ runner.temp }}
          MATRIX_NAME: ${{ matrix.name }}
          MATRIX_STAGE: ${{ matrix.image_stage }}
        run: |
          if [ "$PUSH" == "true" ]; then
            echo "output=type=image,push=true" >> $GITHUB_OUTPUT
          else
            echo "output=type=docker,dest=$RUNNER_TEMP/image-$MATRIX_NAME-$MATRIX_STAGE.tar" >> $GITHUB_OUTPUT
          fi

      - name: Build ${{ matrix.image_stage }} image stage for ${{ matrix.name }}
        if: steps.should_skip.outputs.skip != 'true'
        uses: docker/build-push-action@263435318d21b8e681c14492fe198d362a7d2c83 #v6.18.0
        with:
          context: .
          target: ${{ matrix.image_stage }}
          push: ${{ inputs.push }}
          load: false
          tags: ${{ steps.resolve_tag.outputs.tag }}
          platforms: "${{ matrix.platform }}"
          cache-from: type=${{ inputs.cache_from_type }}
          cache-to: type=${{ inputs.cache_from_type }},mode=max
          outputs: ${{ steps.output.outputs.output }}

      - name: Upload image artifact
        if: steps.should_skip.outputs.skip != 'true' && inputs.push != true
        uses: actions/upload-artifact@v4
        with:
          name: image-${{ matrix.name }}-${{ matrix.image_stage }}-${{ needs.prepare_environment.outputs.dockerfile_hash }}-artifact
          path: ${{ runner.temp }}/image-${{ matrix.name }}-${{ matrix.image_stage }}.tar
          retention-days: 1
          if-no-files-found: error
          compression-level: 0
          overwrite: true
