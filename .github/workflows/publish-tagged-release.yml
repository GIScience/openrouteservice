name: Build and publish the newest version and latest Docker image
on:
  release:
    types: [published]

jobs:
  parse_tag:
    name: Parse release tag and determine if build is needed
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.parse.outputs.tag }}
      tags_version: ${{ steps.parse.outputs.tags_version }}
      tags_latest: ${{ steps.parse.outputs.tags_latest }}
      build_version: ${{ steps.parse.outputs.build_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Parse release tag
        id: parse
        uses: ./.github/actions/parse-release-tag
        with:
          tag: ${{ github.event.release.tag_name }}

  build_and_push_publish_images:
    name: Build and cache the Docker images with native runners
    needs: parse_tag
    if: ${{ needs.parse_tag.outputs.build_version == 'true' }}
    uses: ./.github/workflows/_reusable_build_docker_images.yml
    with:
      upload_image_as_artifact: false
      build_amd64: true
      build_arm64: true
      image_stage: 'publish'
      push_by_digest: true
      docker_login: true
      docker_tag: 'openrouteservice/openrouteservice' # push_by_digest doesn't need a tag suffix
      dockerfile_path: 'Dockerfile'
    secrets:
      registry_username: ${{ secrets.DOCKER_USERNAME }}
      registry_password: ${{ secrets.DOCKER_PASSWORD }}
  
  build_and_push_slim_images:
    name: Build and cache the slim Docker images with native runners
    needs: parse_tag
    if: ${{ needs.parse_tag.outputs.build_version == 'true' }}
    uses: ./.github/workflows/_reusable_build_docker_images.yml
    with:
      upload_image_as_artifact: false
      build_amd64: true
      build_arm64: true
      image_stage: 'slim'
      push_by_digest: true
      docker_login: true
      docker_tag: 'openrouteservice/openrouteservice' # push_by_digest doesn't need a tag suffix
      dockerfile_path: 'Dockerfile'
    secrets:
      registry_username: ${{ secrets.DOCKER_USERNAME }}
      registry_password: ${{ secrets.DOCKER_PASSWORD }}
  
  combine_and_push_publish_image:
    name: Combine multi-arch manifest and push to DockerHub
    runs-on: ubuntu-latest
    if: ${{ needs.parse_tag.outputs.build_version == 'true' }}
    needs:
      - parse_tag
      - build_and_push_publish_images
      - build_and_push_slim_images
    strategy:
      matrix:
        include:
          - name: "Release image ${{ needs.parse_tag.outputs.tags_version }}"
            image_stage: 'publish'
            image_tag: ${{ needs.parse_tag.outputs.tags_version }}
            digest_amd64: ${{ needs.build_and_push_publish_images.outputs.image_digest_amd64 }}
            digest_arm64: ${{ needs.build_and_push_publish_images.outputs.image_digest_arm64 }}
          - name: "Release ${{ needs.parse_tag.outputs.tags_latest }}"
            image_stage: 'publish'
            image_tag: ${{ needs.parse_tag.outputs.tags_latest }}
            digest_amd64: ${{ needs.build_and_push_publish_images.outputs.image_digest_amd64 }}
            digest_arm64: ${{ needs.build_and_push_publish_images.outputs.image_digest_arm64 }}
          - name: "Release image ${{ needs.parse_tag.outputs.tags_version }}-slim"
            image_stage: 'slim'
            image_tag: ${{ needs.parse_tag.outputs.tags_version }}-slim
            digest_amd64: ${{ needs.build_and_push_slim_images.outputs.image_digest_amd64 }}
            digest_arm64: ${{ needs.build_and_push_slim_images.outputs.image_digest_arm64 }}
          - name: "Release image ${{ needs.parse_tag.outputs.tags_latest }}-slim"
            image_stage: 'slim'
            image_tag: ${{ needs.parse_tag.outputs.tags_latest }}-slim
            digest_amd64: ${{ needs.build_and_push_slim_images.outputs.image_digest_amd64 }}
            digest_arm64: ${{ needs.build_and_push_slim_images.outputs.image_digest_arm64 }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Set up build environment
        uses: ./.github/actions/setup-build-environment
        with:
          with_java: false
          with_docker: true
          with_qemu: false
          with_docker_cache_injection: false
          docker_login: true
          docker_username: ${{ secrets.DOCKER_USERNAME }}
          docker_password: ${{ secrets.DOCKER_PASSWORD }}
          dockerfile: 'Dockerfile'
      - name: Create and push manifest for ${{ matrix.name }}
        env:
          IMAGE_REPO: openrouteservice/openrouteservice:${{ matrix.image_tag }}
          DIGEST_AMD64: ${{ matrix.digest_amd64 }}
          DIGEST_ARM64: ${{ matrix.digest_arm64 }}
        run: |
          if [ -z "$DIGEST_AMD64" ] || [ -z "$DIGEST_ARM64" ]; then
            echo "Error: Missing digests for multi-arch manifest"
            echo "AMD64: $DIGEST_AMD64"
            echo "ARM64: $DIGEST_ARM64"
            exit 1
          fi
          
          echo "Create and push manifest list for ${{ matrix.image_stage }} - ${{ matrix.image_tag }}"
          docker buildx imagetools create \
            -t "$IMAGE_REPO" \
            "openrouteservice/openrouteservice@${DIGEST_AMD64}" \
            "openrouteservice/openrouteservice@${DIGEST_ARM64}"

          echo "Successfully pushed multi-arch image: $IMAGE_REPO"

  build_and_publish_release_artifacts:
    if: ${{ needs.parse_tag.outputs.build_version == 'true' }}
    runs-on: ubuntu-latest
    needs: [parse_tag, combine_and_push_publish_image]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up build environment
        uses: ./.github/actions/setup-build-environment
        with:
          with_java: true
          with_docker: false
          java_version: 21
      - name: Build JAR
        run: |
          ./mvnw -q clean package -DskipTests
          # Copy the JAR to the root directory
          cp ors-api/target/ors.jar ors.jar
      - name: Build WAR
        run: |
          ./mvnw -q clean package -DskipTests -PbuildWar
          # Copy the WAR to the root directory
          cp ors-api/target/ors.war ors.war
      - name: Rewrite the docker-compose.yml image tag to the release tag
        run: |
          # Replace the image part
          sed -i "s/local\/openrouteservice:latest/openrouteservice\/openrouteservice:${{ needs.parse_tag.outputs.tag }}/g" docker-compose.yml
      - name: Attach the files to the release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          files: |
            ./ors.jar
            ./ors.war
            ./ors-config.yml
            ./ors-config.env
            ./docker-compose.yml