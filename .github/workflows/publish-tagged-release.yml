name: Build and publish the newest version and latest Docker image
on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      tag:
        description: 'Release tag to build from dispatch (overrides github.event.release.tag_name)'
        required: true

jobs:
  parse_tag:
    name: Parse release tag and determine if build is needed
    runs-on: ubuntu-latest
    outputs:
      tag: ${{ steps.parse.outputs.tag }}
      tags_version: ${{ steps.parse.outputs.tags_version }}
      tags_latest: ${{ steps.parse.outputs.tags_latest }}
      build_version: ${{ steps.parse.outputs.build_version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Parse release tag
        id: parse
        uses: ./.github/actions/parse-release-tag
        with:
          tag: ${{ github.event.inputs.tag || '' }}

  build_docker_images:
    name: Build and push the image to docker hub
    needs: parse_tag
    if: ${{ needs.parse_tag.outputs.build_version == 'true' }}
    uses: ./.github/workflows/_reusable_build_docker_images.yml
    with:
      upload_image_as_artifact: false
      build_amd64: true
      build_arm64: true
      image_stage: 'publish'
      docker_tag: ${{ needs.parse_tag.outputs.tags_version }},${{ needs.parse_tag.outputs.tags_latest }}
      dockerfile_path: 'Dockerfile'
  
  publish_docker_image:
    name: Publish Docker image to DockerHub
    runs-on: ubuntu-latest
    if: ${{ needs.parse_tag.outputs.build_version == 'true' }}
    needs:
      - parse_tag
      - build_docker_images
    steps:
      - name: Checkout normally
        uses: actions/checkout@v4
      - name: Setup Build environment
        uses: ./.github/actions/setup-build-environment
        with:
          with_java: true
          with_docker: true
          with_qemu: true
          with_docker_cache_injection: true
          java_version: 21
          dockerfile: 'Dockerfile'

      - name: Build and publish manual version
        if: ${{ github.event_name == 'workflow_dispatch' && needs.parse_tag.outputs.build_version == 'true' }}
        uses: ./.github/actions/build-docker-image
        with:
          dockerfile_path: 'Dockerfile'
          image_stage: 'publish'
          docker_tag: ${{ needs.parse_tag.outputs.tags_version }}
          platform: 'linux/amd64,linux/arm64'
          push_image: true
          cache_from_type: gha
          cache_to_type: ''
      - name: Build and publish release version
        if: ${{ github.event_name == 'release' && needs.parse_tag.outputs.build_version == 'true' }}
        uses: ./.github/actions/build-docker-image
        with:
          dockerfile_path: 'Dockerfile'
          image_stage: 'publish'
          docker_tag: ${{ needs.parse_tag.outputs.tags_version }},${{ needs.parse_tag.outputs.tags_latest }}
          platform: 'linux/amd64,linux/arm64'
          push_image: true
          cache_from_type: gha
          cache_to_type: ''

  build_and_publish_release_artifacts:
    runs-on: ubuntu-latest
    needs: [parse_tag, publish_docker_image]
    if: ${{ needs.parse_tag.outputs.build_version == 'true' && github.event_name == 'release' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up build environment
        uses: ./.github/actions/setup-build-environment
        with:
          with_java: true
          with_docker: false
          java_version: 21
      - name: Build JAR
        run: |
          ./mvnw -q clean package -DskipTests
          # Copy the JAR to the root directory
          cp ors-api/target/ors.jar ors.jar
      - name: Build WAR
        run: |
          ./mvnw -q clean package -DskipTests -PbuildWar
          # Copy the WAR to the root directory
          cp ors-api/target/ors.war ors.war
      - name: Rewrite the docker-compose.yml image tag to the release tag
        run: |
          # Replace the image part
          sed -i "s/local\/openrouteservice:latest/openrouteservice\/openrouteservice:${{ needs.parse_tag.outputs.tag }}/g" docker-compose.yml
      - name: Attach the files to the release
        uses: softprops/action-gh-release@v1
        if: startsWith(github.ref, 'refs/tags/')
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          files: |
            ./ors.jar
            ./ors.war
            ./ors-config.yml
            ./ors-config.env
            ./docker-compose.yml