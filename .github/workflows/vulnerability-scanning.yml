name: "Vulnerability scan"

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]
  schedule:
    - cron: '0 0 * * MON'

permissions:
  contents: read

env:
  TEST_IMAGE_NAME: 'local/openrouteservice:test'

jobs:
  prepare_environment:
    name: Prepare environment
    runs-on: ubuntu-latest
    outputs:
      dockerfile_hash: ${{ steps.dockerfile-hash.outputs.hash }}
      is_draft: ${{ steps.check-draft.outputs.is_draft }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate Dockerfile hash
        id: dockerfile-hash
        run: |
          HASH=$(sha256sum "Dockerfile" | cut -d' ' -f1 | cut -c1-8)
          echo "hash=$HASH" >> $GITHUB_OUTPUT

      - name: Check if draft PR
        id: check-draft
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" && "${{ github.event.pull_request.draft }}" == "true" ]]; then
            echo "is_draft=true" >> $GITHUB_OUTPUT
          else
            echo "is_draft=false" >> $GITHUB_OUTPUT
          fi

  Anchore-Jar-War-Build-Scan:
    name: Grype scan jar and war file
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Setup build environment
        uses: ./.github/actions/setup-build-environment
        with:
          with_docker: 'false'
      - name: Build jar and war file
        run: |
          ./mvnw -B package -DskipTests -DCI=true
          # Copy the .jar file to a custom location where grype can find it
          mkdir -p ors-api/target/grype
          cp ors-api/target/ors.jar ors-api/target/grype/ors.jar
          ./mvnw -B package -DskipTests -PbuildWar -DCI=true
          cp ors-api/target/ors.war ors-api/target/grype/ors.war
      - name: Run the Anchore Grype scan action to console
        uses: anchore/scan-action@v5
        with:
          path: "ors-api/target/grype/"
          fail-build: false
          output-format: table
      - name: Run the Anchore Grype scan action to SARIF
        uses: anchore/scan-action@v5
        id: scan
        with:
          path: "ors-api/target/grype/"
          fail-build: false
          output-format: sarif
      - name: Upload vulnerability report
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ steps.scan.outputs.sarif }}
          category: Grype-War-Scan
  
  build_amd64_image:
    name: Build Docker image for linux/amd64
    uses: ./.github/workflows/_reusable_build_docker_images.yml
    needs: prepare_environment
    with:
      platform: linux/amd64
      image_stage: publish
      docker_tag: local/openrouteservice:test
  
  build_arm64_image:
    if: ${{ !(github.event_name == 'pull_request' && github.event.pull_request.draft) }}
    name: Build Docker image for linux/arm64
    uses: ./.github/workflows/_reusable_build_docker_images.yml
    needs: prepare_environment
    with:
      platform: linux/arm64
      image_stage: publish
      docker_tag: local/openrouteservice:test

  scan_images:
    name: Scan ${{ matrix.platform_name }} image
    runs-on: ${{ matrix.runner }}
    needs:
      - prepare_environment
      - build_amd64_image
      - build_arm64_image
    if: always()
    permissions:
      actions: read
      contents: read
      security-events: write
    strategy:
      matrix:
        include:
          - platform: linux/amd64
            platform_name: linux_amd64
            image_stage: publish
            runner: ubuntu-latest
            skip_on_draft: false
            artifact_name: ${{ needs.build_amd64_image.outputs.artifact_name }}
          - platform: linux/arm64
            platform_name: linux_arm64
            image_stage: publish
            runner: ubuntu-24.04-arm
            skip_on_draft: true
            artifact_name: ${{ needs.build_arm64_image.outputs.artifact_name }}
    steps:
      - name: Skip condition
        id: skip-condition
        run: |
          if [[ "${{ needs.prepare_environment.outputs.is_draft }}" == "true" && "${{ matrix.skip_on_draft }}" == "true" ]]; then
            echo "Skipping scan for draft PR on platform ${{ matrix.platform_name }}"
            echo "skip=true" >> $GITHUB_OUTPUT
          else
            echo "skip=false" >> $GITHUB_OUTPUT
          fi
      - name: Check artifact availability
        if: ${{ steps.skip-condition.outputs.skip != 'true' }}
        run: |
          if [[ -z "${{ matrix.artifact_name }}" ]]; then
            echo "Artifact not available for platform ${{ matrix.platform_name }}"
            exit 1
          fi
      - name: Checkout repository
        if: ${{ steps.skip-condition.outputs.skip != 'true' }}
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup build environment
        if: ${{ steps.skip-condition.outputs.skip != 'true' }}
        uses: ./.github/actions/setup-build-environment
        with:
          with_java: false
          with_docker: true
          with_docker_cache_injection: false

      - name: Download image artifact
        if: ${{ steps.skip-condition.outputs.skip != 'true' }}
        uses: actions/download-artifact@v4
        with:
          name: ${{ matrix.artifact_name }}
          path: ${{ runner.temp }}/

      - name: Load image
        if: ${{ steps.skip-condition.outputs.skip != 'true' }}
        run: |
          docker load --input ${{ runner.temp }}/${{ matrix.artifact_name }}

      - name: Run the Anchore Grype scan action to console
        if: ${{ steps.skip-condition.outputs.skip != 'true' }}
        uses: anchore/scan-action@v5
        with:
          image: ${{ env.TEST_IMAGE_NAME }}
          fail-build: false
          output-format: table

      - name: Run the Anchore Grype scan action to SARIF
        if: ${{ steps.skip-condition.outputs.skip != 'true' }}
        uses: anchore/scan-action@v5
        id: scan
        with:
          image: ${{ env.TEST_IMAGE_NAME }}
          fail-build: false
          output-format: sarif

      - name: Upload vulnerability report
        if: ${{ steps.skip-condition.outputs.skip != 'true' }}
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: ${{ steps.scan.outputs.sarif }}
          category: Grype-Docker-Image-${{ matrix.platform }}
