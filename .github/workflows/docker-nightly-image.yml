name: Docker Nightly Image CI
run-name: Build ${{ inputs.branch }} - ${{ inputs.user }}

on:
  schedule:
    - cron: '15 1 * * *'
  workflow_dispatch:
    inputs:
      repository:
        description: 'GitHub repository to create image off.'
        required: true
        default: 'GIScience/openrouteservice'
      branch:
        description: 'GitHub branch to create image off.'
        required: true
        default: 'main'
      tag:
        description: 'Name of the docker tag to create.'
        required: true
        default: 'nightly'
      ignore-24h-commit-check:
        description: 'Build image regardless of last commit date.'
        required: true
        type: boolean
        default: false
      user:
        description: ''
        required: false
        default: 'schedule'

jobs:
  setup-build-environment:
    runs-on: ubuntu-latest
    outputs:
      new_commits: ${{ steps.check.outputs.NEW_COMMITS }}
      publish_image_tag: ${{ steps.image-tags.outputs.publish_image_tag }}
      slim_image_tag: ${{ steps.image-tags.outputs.slim_image_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repository || 'GIScience/openrouteservice' }}
          ref: ${{ inputs.branch || 'main' }}

      - name: Check for new commits since 24 h ago
        id: check
        run: |
          export LOG_LINES=$(git log --oneline --since '24 hours ago')
          export NUM_LINES=$(echo "$LOG_LINES" | grep -c .)
          if [ "$NUM_LINES" -eq "0" ]; then
            export NEW_COMMITS="false"
          else
            export NEW_COMMITS="true"
          fi
          echo "NEW_COMMITS=$NEW_COMMITS" >> "$GITHUB_OUTPUT"
      - name: Set Docker image tag
        id: image-tags
        run: |
          BASE_TAG=openrouteservice/openrouteservice:"${{ inputs.tag || 'nightly' }}"
          echo "publish_image_tag=${BASE_TAG}" >> $GITHUB_OUTPUT
          echo "slim_image_tag=${BASE_TAG}-slim" >> $GITHUB_OUTPUT
          echo "Docker publish stage image tag: ${BASE_TAG}"
          echo "Docker slim stage image tag: ${BASE_TAG}-slim"
  
  build_and_push_publish_images:
    needs:
      - setup-build-environment
    uses: ./.github/workflows/_reusable_build_docker_images.yml
    if: inputs.ignore-24h-commit-check || needs.setup-build-environment.outputs.new_commits == 'true'
    with:
      dockerfile_path: 'Dockerfile'
      image_stage: 'publish'
      java_version: 21
      build_amd64: true
      build_arm64: true
      push_by_digest: true
      docker_login: true
      docker_tag: openrouteservice/openrouteservice # push by digest needs no tag suffix
    secrets:
      registry_username: ${{ secrets.DOCKER_USERNAME }}
      registry_password: ${{ secrets.DOCKER_PASSWORD }}
  
  build_and_push_slim_images:
    needs:
      - setup-build-environment
    uses: ./.github/workflows/_reusable_build_docker_images.yml
    if: inputs.ignore-24h-commit-check || needs.setup-build-environment.outputs.new_commits == 'true'
    with:
      dockerfile_path: 'Dockerfile'
      image_stage: 'slim'
      java_version: 21
      build_amd64: true
      build_arm64: true
      push_by_digest: true
      docker_login: true
      docker_tag: openrouteservice/openrouteservice # push by digest needs no tag suffix
    secrets:
      registry_username: ${{ secrets.DOCKER_USERNAME }}
      registry_password: ${{ secrets.DOCKER_PASSWORD }}

  combine_and_push_multi_arch_manifests:
    needs:
      - setup-build-environment
      - build_and_push_publish_images
      - build_and_push_slim_images
    name: Combine multi-arch manifests and push to DockerHub
    runs-on: ubuntu-latest
    if: inputs.ignore-24h-commit-check || needs.setup-build-environment.outputs.new_commits == 'true'
    strategy:
      matrix:
        include:
          - image_stage: 'publish'
            image_tag: ${{ needs.setup-build-environment.outputs.publish_image_tag }}
            digest_amd64: ${{ needs.build_and_push_publish_images.outputs.image_digest_amd64 }}
            digest_arm64: ${{ needs.build_and_push_publish_images.outputs.image_digest_arm64 }}
          - image_stage: 'slim'
            image_tag: ${{ needs.setup-build-environment.outputs.slim_image_tag }}
            digest_amd64: ${{ needs.build_and_push_slim_images.outputs.image_digest_amd64 }}
            digest_arm64: ${{ needs.build_and_push_slim_images.outputs.image_digest_arm64 }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.repository || 'GIScience/openrouteservice' }}
          ref: ${{ inputs.branch || 'main' }}
      - name: Set up build environment
        uses: ./.github/actions/setup-build-environment
        with:
          with_java: false
          with_docker: true
          with_qemu: false
          with_docker_cache_injection: false
          docker_login: true
          docker_username: ${{ secrets.DOCKER_USERNAME }}
          docker_password: ${{ secrets.DOCKER_PASSWORD }}
          dockerfile: 'Dockerfile'
      - name: Create and push manifest list for ${{ matrix.image_stage }}
        env:
          IMAGE_REPO: ${{ matrix.image_tag }}
          DIGEST_AMD64: ${{ matrix.digest_amd64 }}
          DIGEST_ARM64: ${{ matrix.digest_arm64 }}
        run: |
          if [ -z "$DIGEST_AMD64" ] || [ -z "$DIGEST_ARM64" ]; then
            echo "Error: Missing digests for multi-arch manifest"
            echo "AMD64: $DIGEST_AMD64"
            echo "ARM64: $DIGEST_ARM64"
            exit 1
          fi
          
          echo "Create and push manifest list for $IMAGE_REPO"
          docker buildx imagetools create \
            -t "$IMAGE_REPO" \
            "${IMAGE_REPO%:*}@${DIGEST_AMD64}" \
            "${IMAGE_REPO%:*}@${DIGEST_ARM64}"

          echo "Successfully pushed multi-arch image: $IMAGE_REPO"

