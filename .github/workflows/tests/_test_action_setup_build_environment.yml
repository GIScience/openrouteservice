# Test Setup Build Environment Action
# ===================================
# Test suite for the setup-build-environment composite action.
#
# Tests validate:
# - Java/Maven setup with custom versions
# - Docker Buildx setup and configuration
# - Maven dependency caching and cache-hit output
# - Dockerfile preparation for cache mounts
# - Conditional Docker setup (enabled/disabled)
# - Output parameter correctness and formatting
#
# Triggers: Push/PR to action files, manual workflow_dispatch
# Local testing: act -j test_action_setup_build_environment

name: Test Setup Build Environment Action

on:
  push:
    branches: [ "main" ]
    paths:
      - '.github/actions/setup-build-environment/**'
      - '.github/workflows/test_action_setup_build_environment.yml'
  pull_request:
    branches: [ "**" ]
    paths:
      - '.github/actions/setup-build-environment/**'
      - '.github/workflows/test_action_setup_build_environment.yml'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  test_action_setup_build_environment:
    name: Test setup-build-environment action
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test 1 - Setup with Docker (default configuration)
        id: test1_docker
        uses: ./.github/actions/setup-build-environment

      - name: Verify Test 1 outputs
        run: |
          echo "Buildx Builder: ${{ steps.test1_docker.outputs.buildx_builder }}"
          echo "Cache Hit: ${{ steps.test1_docker.outputs.cache-hit }}"
          
          # Assertions
          if [ -z "${{ steps.test1_docker.outputs.buildx_builder }}" ]; then
            echo "❌ Test 1 FAILED: Expected buildx_builder output when with_docker=true (default)"
            exit 1
          fi
          
          cache_hit="${{ steps.test1_docker.outputs.cache-hit }}"
          if [ "$cache_hit" != "true" ] && [ "$cache_hit" != "false" ]; then
            echo "❌ Test 1 FAILED: cache-hit should be 'true' or 'false', got '$cache_hit'"
            exit 1
          fi
          
          echo "Test 1 PASSED: Default configuration with Docker works correctly"
    
      - name: Test 2 - Docker Buildx setup verification
        run: |
          # Check if Docker is available
          if ! command -v docker &> /dev/null; then
            echo "❌ Test 2 FAILED: Docker not found in PATH"
            exit 1
          fi
          
          # Check if buildx is available
          if ! docker buildx version &> /dev/null; then
            echo "❌ Test 2 FAILED: Docker Buildx not available"
            exit 1
          fi
          
          echo "Test 2 PASSED: Docker Buildx is available"

      - name: Test 3 - Setup without Docker
        id: test3_no_docker
        uses: ./.github/actions/setup-build-environment
        with:
          with_docker: 'false'

      - name: Verify Test 3 outputs
        run: |
          echo "Buildx Builder: ${{ steps.test3_no_docker.outputs.buildx_builder }}"
          echo "Cache Hit: ${{ steps.test3_no_docker.outputs.cache-hit }}"
          
          # Assertions
          if [ -n "${{ steps.test3_no_docker.outputs.buildx_builder }}" ]; then
            echo "❌ Test 3 FAILED: Expected no buildx_builder output when with_docker=false, got '${{ steps.test3_no_docker.outputs.buildx_builder }}'"
            exit 1
          fi
          
          cache_hit="${{ steps.test3_no_docker.outputs.cache-hit }}"
          if [ "$cache_hit" != "true" ] && [ "$cache_hit" != "false" ]; then
            echo "❌ Test 3 FAILED: cache-hit should be 'true' or 'false', got '$cache_hit'"
            exit 1
          fi
          
          echo "Test 3 PASSED: Configuration without Docker works correctly"

      - name: Test 4 - Custom Java version
        id: test4_java_version
        uses: ./.github/actions/setup-build-environment
        with:
          java_version: '17'
          with_docker: 'false'

      - name: Verify Test 4 - Java version setup
        run: |
          echo "Cache Hit: ${{ steps.test4_java_version.outputs.cache-hit }}"
          
          # Verify Java is available and correct version
          if ! command -v java &> /dev/null; then
            echo "❌ Test 4 FAILED: Java not found in PATH"
            exit 1
          fi
          
          java_version=$(java -version 2>&1 | head -n 1 | cut -d'"' -f2 | cut -d'.' -f1)
          if [ "$java_version" != "17" ]; then
            echo "❌ Test 4 FAILED: Expected Java 17, got Java $java_version"
            exit 1
          fi
          
          echo "Test 4 PASSED: Custom Java version (17) setup works correctly"

      - name: Test 5 - Dockerfile preparation (with Docker)
        id: test5_dockerfile_prep
        uses: ./.github/actions/setup-build-environment
        with:
          dockerfile: 'Dockerfile'

      - name: Verify Test 5 - Dockerfile modifications
        run: |
          # Check if any Dockerfiles exist
          dockerfiles=$(find . -name "Dockerfile" -o -name "*.Dockerfile" | wc -l)
          
          if [ "$dockerfiles" -gt 0 ]; then
            # Check if Dockerfiles contain Maven cache mount instructions
            modified_count=$(grep -l "type=cache,target=/root/.m2/repository" $(find . -name "Dockerfile" -o -name "*.Dockerfile") | wc -l)
            
            if [ "$modified_count" -gt 0 ]; then
              echo "Test 5 PASSED: Dockerfiles were prepared with Maven cache mounts"
            else
              echo "⚠️ Test 5 WARNING: No Dockerfiles found with Maven cache mounts (may be expected if no RUN ./mvnw commands exist)"
            fi
          else
            echo "⚠️ Test 5 INFO: No Dockerfiles found in repository"
          fi

      - name: Summary
        if: always()
        run: |
          echo "=========================================="
          echo "Setup Build Environment Action - Test Summary"
          echo "=========================================="
          echo "✅ All tests executed successfully"
          echo ""
          echo "Test Coverage:"
          echo "  ✓ Test 1: Default configuration with Docker"
          echo "  ✓ Test 2: Docker Buildx setup verification"
          echo "  ✓ Test 3: Configuration without Docker"
          echo "  ✓ Test 4: Custom Java version setup"
          echo "  ✓ Test 5: Dockerfile preparation for cache mounts"
          echo ""
          echo "Key Validations:"
          echo "  - Java setup with correct version"
          echo "  - Maven caching and dependency resolution"
          echo "  - Docker Buildx setup when enabled"
          echo "  - Docker Buildx disabled when requested"
          echo "  - Dockerfile Maven cache mount injection"
          echo "  - Output parameter correctness"
          echo "=========================================="